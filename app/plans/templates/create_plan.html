{% extends "base.html" %}

{% block title %}Создание плана - {{ student.first_name }} {{ student.last_name }}{% endblock %}

{% block styles %}
<style>
    /* Стили для улучшения интерфейса */
    .webinar-card {
        transition: all 0.2s ease;
        cursor: pointer;
        display: flex; /* Ensure cards take height */
        flex-direction: column;
    }
    .webinar-card .card-body {
        flex-grow: 1; /* Allow body to grow */
    }
     .webinar-card .card-footer {
        flex-shrink: 0; /* Prevent footer from shrinking */
        align-items: center; /* Vertically align items in footer */
    }
    .webinar-card:hover {
        transform: translateY(-3px);
    }
    .filter-buttons .btn {
        margin-bottom: 5px;
    }
    .webinar-cover {
        height: 150px; /* Adjusted height */
        display: flex;
        justify-content: center;
        align-items: center;
        overflow: hidden;
        position: relative;
        background-color: #f8f9fa;
        border-radius: calc(0.375rem - 1px) calc(0.375rem - 1px) 0 0;
    }
    .webinar-cover img {
        object-fit: contain;
        max-width: 100%;
        max-height: 100%;
        padding: 0;
    }
    .webinar-cover .btn {
        opacity: 0.8;
        transition: opacity 0.2s ease;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .webinar-cover .btn:hover {
        opacity: 1;
    }
    .task-badge-container {
        min-height: 45px; /* Adjusted height */
        display: block; /* Or inline-block, if needed */
    }
    .badge {
        display: inline-block; /* Ensure badges can wrap */
        margin-right: 2px;
        margin-bottom: 3px; /* Add bottom margin */
    }
    .webinar-title {
        min-height: 4.5em; /* Approx 3 lines height */
        max-height: 4.5em;
        line-height: 1.5em;
        display: -webkit-box;
        -webkit-line-clamp: 3; /* Limit to 3 lines */
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
        margin-bottom: 0.75rem; /* Increased space below title */
    }
    .card-body {
        padding: 0.8rem; /* Slightly reduced padding */
        display: flex;
        flex-direction: column;
    }
     .card-body > div:last-of-type { /* Push date/ID to bottom */
        margin-top: auto;
    }

    .selected-webinar {
        border: 2px solid var(--primary-color); /* Highlight selected */
    }
    .week-section .card {
        background-color: #eef2f7; /* Light blueish background for cards in plan */
    }
    .available-webinars-container .card {
        background-color: #ffffff; /* White background for available */
    }
    .week-container {
        min-height: 200px; /* Ensure container doesn't collapse */
        background-color: rgba(0,0,0,0.02);
        border: 1px dashed #ccc; /* Dashed border */
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 5px;
        display: grid; /* Use grid for layout */
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); /* Responsive grid */
        gap: 1rem; /* Gap between cards */
    }
    .available-webinars-container .row { /* Keep row for available */
         min-height: 200px;
         background-color: rgba(0,0,0,0.01);
         border: 1px dashed #ddd;
         padding: 15px;
         border-radius: 5px;
    }

    .week-container-header {
        font-weight: bold;
        margin-bottom: 15px;
        color: #555;
    }
    .webinar-placeholder {
        text-align: center;
        color: #aaa;
        padding: 20px;
        font-style: italic;
        grid-column: 1 / -1; /* Span full width in grid */
        align-self: center; /* Center vertically */
    }
    .available-webinars-container .webinar-placeholder {
        grid-column: auto; /* Reset for row layout */
        align-self: auto;
    }

    /* Styles for mobile devices */
    @media (max-width: 768px) {
        .filter-buttons {
            margin-top: 10px;
        }
        .week-container {
             grid-template-columns: 1fr; /* Single column on mobile */
        }
    }

    /* Style for disabled select when not checked */
    .week-select:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        background-color: #e9ecef;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Создание плана для {{ student.first_name }} {{ student.last_name }}</h2>
        <a href="{{ url_for('students.student_detail', student_id=student.id) }}" class="btn btn-outline-secondary mb-2">
            <i class="fas fa-arrow-left me-1"></i> Назад к профилю
        </a>
    </div>

    <form method="post" id="create-plan-form">
        {# CSRF Token #}
        <input type="hidden" name="csrf_token" value="{{ csrf_token_value }}"/>

        {# Block with information and plan parameters #}
        <div class="card mb-4 shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Параметры плана</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Студент:</strong> {{ student.first_name }} {{ student.last_name }}</p>
                        <p><strong>Целевой балл:</strong> {{ student.target_score or 'Не указан' }}</p>
                        <p><strong>Часов в неделю:</strong> {{ student.hours_per_week or 'Не указано' }}</p>
                        <p><strong>Уровень:</strong> {% if student.is_beginner %}Начинающий{% else %}Базовый{% endif %}</p>
                    </div>
                    <div class="col-md-6">
                        {# Quotas for T26 and T27 #}
                        <div class="mb-3">
                            <label for="quota_t26" class="form-label">Квота вебинаров на Задание 26 (0 - без квоты)</label>
                            <input type="number" class="form-control" id="quota_t26" name="quota_t26" value="0" min="0">
                        </div>
                        <div class="mb-3">
                            <label for="quota_t27" class="form-label">Квота вебинаров на Задание 27 (0 - без квоты)</label>
                            <input type="number" class="form-control" id="quota_t27" name="quota_t27" value="0" min="0">
                        </div>
                        <button type="button" class="btn btn-secondary btn-sm" id="recalculate-recommendations">
                            <i class="fas fa-redo me-1"></i> Пересчитать рекомендации
                        </button>
                        <div class="form-text">Нажмите, чтобы обновить список рекомендуемых вебинаров с учетом квот.</div>
                    </div>
                </div>
                 <div class="mt-3">
                     <p class="mb-1"><strong>Необходимые задания (исходя из цели):</strong></p>
                     <div class="d-flex flex-wrap gap-1">
                         {% for task_num in required_tasks %}
                            <span class="badge {% if task_num in known_task_numbers %}bg-success{% else %}bg-secondary{% endif %}">
                                {{ task_num }} {% if task_num in known_task_numbers %}<i class="fas fa-check ms-1"></i>{% endif %}
                            </span>
                         {% else %}
                             <span class="text-muted">Нет данных</span>
                         {% endfor %}
                     </div>
                 </div>
            </div>
        </div>

        {# Containers for weeks - Using grid layout now #}
        <div class="row">
            {% for week_num in range(1, 5) %}
            <div class="col-12 mb-4"> {# Full width column for each week section #}
                <div class="card week-section h-100 shadow-sm">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-calendar-week me-2"></i> Неделя {{ week_num }}
                            <span class="badge bg-primary float-end week-counter" id="week-{{ week_num }}-counter">0</span>
                        </h5>
                    </div>
                    {# The container for the cards #}
                    <div class="card-body week-container" id="week-{{ week_num }}-container">
                        {# Placeholder added/removed by JS #}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>


        {# Available webinars #}
        <div class="card mt-4 mb-4 shadow-sm">
             <div class="card-header bg-light d-flex justify-content-between align-items-center flex-wrap">
                <h5 class="mb-0 me-3">Доступные вебинары (<span id="available-counter">0</span>)</h5>
                 {# Filter/Search for available webinars #}
                 <input type="text" id="availableWebinarSearchInput" class="form-control form-control-sm" style="max-width: 300px;" placeholder="Поиск среди доступных...">
            </div>
            <div class="card-body available-webinars-container">
                 {# Container for the cards - using default row/cols #}
                <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 row-cols-xl-4 g-3" id="available-webinars-inner-container">
                     {# Placeholder added/removed by JS #}
                </div>
            </div>
        </div>

        {# Save/Cancel Buttons #}
        <div class="d-grid gap-2 d-md-flex justify-content-md-end mb-4">
            <a href="{{ url_for('students.student_detail', student_id=student.id) }}" class="btn btn-secondary me-md-2">Отмена</a>
            <button type="submit" class="btn btn-primary">Сохранить план</button>
        </div>

        {# Hidden container for all webinar cards (for JS) #}
        <div id="all-webinars-data" style="display: none;">
             {# Generate all cards HERE, including recommended and others #}
            {% set initial_planned_ids = suitable_webinars|map(attribute='id')|list %}

            {# First, recommended ones #}
            {% for webinar in suitable_webinars %}
                {% set week_num = webinar_weeks.get(webinar.id, 1) %}
                {{ render_webinar_card(webinar, known_task_numbers, watched_webinar_ids, is_checked=True, selected_week=week_num) }}
            {% endfor %}

            {# Then, the rest (not watched and not in recommendations) #}
            {% for webinar in webinars %}
                {% if webinar.id not in watched_webinar_ids and webinar.id not in initial_planned_ids %}
                     {{ render_webinar_card(webinar, known_task_numbers, watched_webinar_ids, is_checked=False, selected_week=1) }}
                {% endif %}
            {% endfor %}
        </div>

    </form> {# End of form #}
</div> {# End of container #}

{# Macro for rendering the webinar card #}
{% macro render_webinar_card(webinar, known_tasks, watched_ids, is_checked=False, selected_week=1) %}
<div class="webinar-item" data-webinar-id="{{ webinar.id }}" data-title="{{ webinar.title|lower }}" data-tasks="{{ webinar.task_numbers|map(attribute='number')|join(',') }}">
    <div class="card webinar-card h-100 {% if is_checked %}selected-webinar{% endif %}" data-id="{{ webinar.id }}">
        <div class="webinar-cover">
             {% if webinar.cover_url %}
                <img src="{{ webinar.cover_url }}" class="card-img-top" alt="{{ webinar.title }}">
            {% else %}
                <div class="text-center text-muted py-4"> {# Added padding #}
                    <i class="fas fa-video fa-3x"></i>
                </div>
            {% endif %}
            <div class="position-absolute top-0 end-0 m-2">
                <a href="{{ webinar.url }}" target="_blank" class="btn btn-sm btn-light rounded-circle webinar-action-button" title="Открыть вебинар">
                    <i class="fas fa-external-link-alt"></i>
                </a>
                <button type="button" class="btn btn-sm btn-light rounded-circle copy-link-btn webinar-action-button" data-url="{{ webinar.url }}" title="Скопировать ссылку">
                    <i class="fas fa-copy"></i>
                </button>
            </div>
        </div>
        <div class="card-body">
            <h6 class="card-title webinar-title">{{ webinar.title }}</h6>
            <div class="task-badge-container">
                {% for task in webinar.task_numbers %}
                    <span class="badge {% if task.number in known_tasks %}bg-success{% else %}bg-secondary{% endif %} me-1">
                        №{{ task.number }} {% if task.number in known_tasks %}<i class="fas fa-check"></i>{% endif %}
                    </span>
                {% else %}
                    <span class="badge bg-light text-dark">Без номера</span>
                {% endfor %}
                {# Additional tags if needed #}
                {% if webinar.for_beginners %} <span class="badge bg-info">Python</span> {% endif %}
                {% if webinar.for_advanced %} <span class="badge bg-warning text-dark">Хард</span> {% endif %}
                {% if webinar.for_expert %} <span class="badge bg-danger">Эксперт</span> {% endif %}
            </div>
             <div class="mt-2 small text-muted">
                <span><i class="far fa-calendar-alt"></i> {{ webinar.date.strftime('%d.%m.%Y') if webinar.date else 'Нет даты' }}</span> |
                <span>ID: {{ webinar.url[-5:] if webinar.url and webinar.url|length >= 5 else 'N/A' }}</span>
            </div>
        </div>
        <div class="card-footer bg-transparent d-flex justify-content-between align-items-center">
            <select class="form-select form-select-sm week-select webinar-action-button" name="week_numbers_{{ webinar.id }}" style="width: 120px;" {% if not is_checked %}disabled{% endif %}>
                {% for week in range(1, 5) %}
                <option value="{{ week }}" {% if selected_week == week %}selected{% endif %}>Неделя {{ week }}</option>
                {% endfor %}
            </select>
            <div class="form-check form-switch webinar-action-button">
                <input class="form-check-input webinar-checkbox" type="checkbox"
                       id="webinar_{{ webinar.id }}" name="webinar_ids"
                       value="{{ webinar.id }}" {% if is_checked %}checked{% endif %}
                       data-initial-week="{{ selected_week }}">
            </div>
        </div>
    </div>
</div>
{% endmacro %}

{# --- Add webinar data as JSON for easier JS access --- #}
<script id="webinar-initial-data" type="application/json">
{
    "suitableWebinars": [
        {% for webinar in suitable_webinars -%}
        {
            "id": {{ webinar.id }},
            "category": {{ webinar.category if webinar.category is not none else 'null' }},
            "for_advanced": {{ 'true' if webinar.for_advanced else 'false' }},
            "date": "{{ webinar.date.strftime('%Y-%m-%d') if webinar.date else 'null' }}"
        }{% if not loop.last %},{% endif %}
        {%- endfor %}
    ],
    "webinarWeeks": {{ webinar_weeks | tojson | safe }}
}
</script>

{% endblock %}


{% block scripts %}
{{ super() }}
{# Подключаем SortableJS #}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const allWebinarsContainer = document.getElementById('all-webinars-data');
    const availableContainer = document.getElementById('available-webinars-inner-container'); // Target the inner row
    const weekContainers = {};
    const weekCounters = {};
    const availableCounter = document.getElementById('available-counter');
    const availableSearchInput = document.getElementById('availableWebinarSearchInput');

    // Initialization of week containers and counters
    for (let i = 1; i <= 4; i++) {
        weekContainers[i] = document.getElementById(`week-${i}-container`);
        weekCounters[i] = document.getElementById(`week-${i}-counter`);
        // Remove initial week placeholders if they exist
        const placeholder = weekContainers[i]?.querySelector('.webinar-placeholder');
        if (placeholder) placeholder.remove();
    }
     // Remove initial available placeholder if it exists
     const availablePlaceholder = availableContainer?.querySelector('.webinar-placeholder');
     if (availablePlaceholder) availablePlaceholder.remove();

    // --- Placeholders Map ---
    const placeholders = new Map();
    function getPlaceholder(container, message) {
        if (!container) return null; // Добавим проверку
        if (!placeholders.has(container)) {
            const placeholder = document.createElement('div');
            placeholder.className = 'webinar-placeholder'; // Only this class needed now
            placeholder.textContent = message;
            placeholders.set(container, placeholder);
        }
        const ph = placeholders.get(container);
        ph.textContent = message; // Обновляем текст всегда
        return ph;
    }

    // Function to update counters and placeholders
    function updateCountersAndPlaceholders() {
        let availableCount = availableContainer?.querySelectorAll('.webinar-item:not(.sortable-ghost)').length || 0; // Игнорируем "призрак"
        if(availableCounter) availableCounter.textContent = availableCount;

        // Update available placeholder
        const availPhContainer = document.getElementById('available-webinars-inner-container'); // Target inner row
         const availPhMessage = availableSearchInput?.value ? `Нет доступных вебинаров по запросу "${availableSearchInput.value}"` : 'Нет доступных вебинаров';
        const availPlaceholder = getPlaceholder(availPhContainer, availPhMessage);

        if (availPlaceholder && availPhContainer) {
            if (availableCount === 0) {
                 if (!availPhContainer.contains(availPlaceholder)) {
                    availPhContainer.appendChild(availPlaceholder);
                    availPhContainer.classList.add('justify-content-center', 'align-items-center', 'w-100'); // Center placeholder
                 }
            } else {
                if (availPhContainer.contains(availPlaceholder)) {
                    availPhContainer.removeChild(availPlaceholder);
                    availPhContainer.classList.remove('justify-content-center', 'align-items-center', 'w-100');
                }
            }
        }

        let totalInPlan = 0;
        for (let i = 1; i <= 4; i++) {
            let weekCount = 0;
            const weekContainer = weekContainers[i];
            if (weekContainer) {
                 weekCount = weekContainer.querySelectorAll('.webinar-item:not(.sortable-ghost)').length; // Игнорируем "призрак"
                 if(weekCounters[i]) weekCounters[i].textContent = weekCount;
                 totalInPlan += weekCount;

                 // Update week placeholder
                 const weekPlaceholder = getPlaceholder(weekContainer, 'Нет вебинаров на этой неделе');
                 if (weekPlaceholder) {
                     if (weekCount === 0) {
                        if (!weekContainer.contains(weekPlaceholder)) {
                            weekContainer.appendChild(weekPlaceholder);
                         }
                     } else {
                        if (weekContainer.contains(weekPlaceholder)) {
                            weekContainer.removeChild(weekPlaceholder);
                        }
                     }
                 }
            }
        }
    }

    // --- Function to update card state based on its container ---
    function updateCardState(item, targetContainer) {
        console.log(`[updateCardState] Updating state for item ${item?.dataset.webinarId} in container`, targetContainer);
        const checkbox = item.querySelector('.webinar-checkbox');
        const weekSelect = item.querySelector('.week-select');
        const card = item.querySelector('.webinar-card');

        if (!checkbox || !weekSelect || !card) {
            console.warn('[updateCardState] Missing elements (checkbox, weekSelect, or card)');
            return;
        }

        let targetWeek = null;
        for (const weekNum in weekContainers) {
            if (weekContainers[weekNum] && weekContainers[weekNum] === targetContainer) {
                targetWeek = parseInt(weekNum, 10);
                break;
            }
        }

        if (targetWeek !== null) { // Moved to a week container
            checkbox.checked = true;
            weekSelect.disabled = false; // Enable select
            weekSelect.value = targetWeek; // Set select to the week it was dropped into
            card.classList.add('selected-webinar');
        } else { // Moved to available container
            checkbox.checked = false;
            weekSelect.disabled = true; // Disable select again
            // Do not reset weekSelect.value, keep the last selected week
            card.classList.remove('selected-webinar');
        }
    }
    // --- End updateCardState ---

    // Event handling for each card
    function setupCardEventListeners(webinarItem) {
        console.log('Setting up listeners for webinar:', webinarItem.dataset.webinarId);
        const checkbox = webinarItem.querySelector('.webinar-checkbox');
        const weekSelect = webinarItem.querySelector('.week-select');
        const card = webinarItem.querySelector('.webinar-card');

        // Checkbox click -> Moves the card and updates state
        checkbox?.addEventListener('change', function() {
            console.log(`[Checkbox Change] Webinar ${webinarItem?.dataset.webinarId} changed to ${this.checked}`);
            const isChecked = this.checked;
            card?.classList.toggle('selected-webinar', isChecked);
            if (weekSelect) weekSelect.disabled = !isChecked; // Enable/disable select

            // Move the card based on checkbox state
            const currentContainer = webinarItem.parentElement;
            if (isChecked) {
                const targetWeek = parseInt(weekSelect?.value || '1', 10);
                 // Check if it's not already in the target week container
                 if (currentContainer !== weekContainers[targetWeek]) {
                    if(weekContainers[targetWeek]) {
                        console.log(`[Checkbox Change] Moving item ${webinarItem?.dataset.webinarId} to Week ${targetWeek}`);
                        weekContainers[targetWeek].appendChild(webinarItem);
                    } else {
                        console.error(`[Checkbox Change] Target container Week ${targetWeek} not found! Moving to available.`);
                        if(availableContainer) availableContainer.appendChild(webinarItem);
                    }
                 }
            } else {
                 // Check if it's not already in the available container
                 if (currentContainer !== availableContainer) {
                    if(availableContainer) {
                        console.log(`[Checkbox Change] Moving item ${webinarItem?.dataset.webinarId} to Available`);
                        availableContainer.appendChild(webinarItem);
                    } else {
                        console.error(`[Checkbox Change] Available container not found!`);
                    }
                 }
            }
             updateCountersAndPlaceholders(); // Update after potential move
        });

        // Week change -> MOVE THIS LOGIC TO DELEGATED LISTENER (COMMENTED OUT)
        /* weekSelect?.addEventListener('change', function() {
            console.log('Week select changed for webinar:', webinarItem.dataset.webinarId);
            console.log('Is checkbox checked?', checkbox?.checked);
            console.log('New week value:', this.value);

            if (checkbox?.checked) { // Move only if webinar is selected
                const targetWeek = parseInt(this.value, 10);
                const currentContainer = webinarItem.parentElement;
                console.log('Target week:', targetWeek);
                console.log('Current container:', currentContainer);
                console.log('Target container:', weekContainers[targetWeek]);

                 // Check if it's not already in the target week container
                 if (currentContainer !== weekContainers[targetWeek]) {
                    console.log('Attempting to move card...');
                    // Check if target container exists
                    if (weekContainers[targetWeek]) {
                        weekContainers[targetWeek].appendChild(webinarItem);
                        updateCountersAndPlaceholders(); // Update after move
                        console.log('Card moved successfully.');
                    } else {
                         console.error(`Target week container ${targetWeek} not found!`);
                    }
                 } else {
                    console.log('Card already in target container.');
                 }
            } else {
                 console.log('Checkbox is not checked, not moving card.');
            }
        }); */

         // Card click (excluding controls)
        card?.addEventListener('click', function(e) {
            // Check if the click target is one of the action buttons/elements
            if (e.target.closest('.webinar-action-button')) {
                return; // Don't toggle checkbox if an action element was clicked
            }
            if (checkbox) {
                 checkbox.checked = !checkbox.checked;
                 // Manually trigger the change event
                 const event = new Event('change', { bubbles: true });
                 checkbox.dispatchEvent(event);
            }
        });

         // Copy link button
        const copyBtn = webinarItem.querySelector('.copy-link-btn');
        copyBtn?.addEventListener('click', function(e) {
            e.stopPropagation(); // Prevent card click toggle
            const url = this.getAttribute('data-url');
            navigator.clipboard.writeText(url).then(() => {
                // Optional: Add visual feedback (e.g., change icon, tooltip)
                console.log('Link copied:', url);
                // Example feedback: temporarily change button text/icon
                const originalIcon = this.innerHTML;
                this.innerHTML = '<i class="fas fa-check text-success"></i>';
                setTimeout(() => { this.innerHTML = originalIcon; }, 1500);
            }, (err) => {
                console.error('Copy failed:', err);
                 alert('Не удалось скопировать ссылку.'); // Inform user
            });
        });
    }

    // --- Simplified SortableJS Initialization ---
    const allSortableContainers = [availableContainer, ...Object.values(weekContainers)];
    allSortableContainers.forEach(container => {
        if (container) {
            new Sortable(container, {
                group: 'shared-webinars',
                animation: 150,
                filter: '.webinar-placeholder',
                preventOnFilter: true,
                ghostClass: 'sortable-ghost',
                chosenClass: 'sortable-chosen',
                dragClass: 'sortable-drag',
                onAdd: function (evt) {
                    const item = evt.item;
                    const toContainer = evt.to;
                    console.log(`[SortableJS onAdd] Item ${item?.dataset.webinarId} added to`, toContainer);
                    updateCardState(item, toContainer);
                    updateCountersAndPlaceholders();
                },
                 onEnd: function(evt) {
                    // Optional: Handle reordering within the same list if needed
                    // console.log('[SortableJS onEnd]', evt);
                    updateCountersAndPlaceholders(); // Ensure counters are updated after any drop
                 }
            });
        } else {
            console.error("Attempted to initialize SortableJS on a null container.");
        }
    });
    // --- End updateCardState ---

    // Event handling for each card
    const allDistributedItems = document.querySelectorAll('.webinar-item');
    allDistributedItems.forEach(item => {
        setupCardEventListeners(item);
    });

    // --- Initial distribution of cards with Priority Sorting within Weeks ---
    const initialWebinarItems = Array.from(allWebinarsContainer?.querySelectorAll('.webinar-item') || []);
    const initialDataElement = document.getElementById('webinar-initial-data');
    const initialData = initialDataElement ? JSON.parse(initialDataElement.textContent) : { suitableWebinars: [], webinarWeeks: {} };

    // Helper function for priority (mirroring Python logic)
    function getJSCreationPriority(webinarData) {
        if (!webinarData) return 5;
        const category = webinarData.category;
        if (category === 1) return 0; // Обязательный
        if (category === 2) return 1; // Повторение
        if (category === 4) return 2; // Для продвинутых
        if (category === 3) return 3; // Не обязательный
        return 4; // Без категории / Остальные
    }

    // Create a map of webinar items by ID for quick lookup
    const itemMap = new Map();
    initialWebinarItems.forEach(item => {
        const webinarId = item.dataset.webinarId;
        if (webinarId) {
            itemMap.set(parseInt(webinarId, 10), item);
            // Detach item initially to re-append later in sorted order
            item.remove(); 
        }
    });

    // Group suitable webinars by week
    const suitableWebinarsById = new Map(initialData.suitableWebinars.map(w => [w.id, w]));
    const suitableByWeek = { 1: [], 2: [], 3: [], 4: [] };
    const suitableIds = new Set();

    for (const webinarIdStr in initialData.webinarWeeks) {
        const webinarId = parseInt(webinarIdStr, 10);
        const weekNum = initialData.webinarWeeks[webinarIdStr];
        const webinarData = suitableWebinarsById.get(webinarId);
        if (webinarData && weekNum >= 1 && weekNum <= 4) {
            suitableByWeek[weekNum].push(webinarData);
            suitableIds.add(webinarId);
        }
    }

    // Sort webinars within each week
    for (let weekNum = 1; weekNum <= 4; weekNum++) {
        suitableByWeek[weekNum].sort((a, b) => {
            const priorityA = getJSCreationPriority(a);
            const priorityB = getJSCreationPriority(b);
            if (priorityA !== priorityB) {
                return priorityA - priorityB;
            }
            // Secondary sort by date (nulls/invalid dates last)
            const dateA = a.date && a.date !== 'null' ? new Date(a.date) : new Date(9999, 0, 1);
            const dateB = b.date && b.date !== 'null' ? new Date(b.date) : new Date(9999, 0, 1);
            if (isNaN(dateA.getTime())) return 1; // Invalid date A last
            if (isNaN(dateB.getTime())) return -1; // Invalid date B last
            return dateA - dateB;
        });

        // Append sorted items to the DOM for this week
        suitableByWeek[weekNum].forEach(webinarData => {
            const item = itemMap.get(webinarData.id);
            if (item && weekContainers[weekNum]) {
                weekContainers[weekNum].appendChild(item);
                // Ensure initial state is correct (checkbox, select)
                const checkbox = item.querySelector('.webinar-checkbox');
                const weekSelect = item.querySelector('.week-select');
                if (checkbox) checkbox.checked = true;
                if (weekSelect) {
                     weekSelect.value = weekNum;
                     weekSelect.disabled = false;
                }
                item.querySelector('.webinar-card')?.classList.add('selected-webinar');
            }
        });
    }

    // Place remaining (non-suitable or initially unchecked) items into available container
    itemMap.forEach((item, webinarId) => {
        if (!suitableIds.has(webinarId)) { // If it wasn't in the suitable/weeks list
            if (availableContainer) {
                availableContainer.appendChild(item);
                // Ensure initial state is correct (unchecked)
                const checkbox = item.querySelector('.webinar-checkbox');
                const weekSelect = item.querySelector('.week-select');
                if (checkbox) checkbox.checked = false;
                if (weekSelect) weekSelect.disabled = true;
                item.querySelector('.webinar-card')?.classList.remove('selected-webinar');
            }
        }
    });
    // --- End Initial Distribution ---

    // Search among available webinars
    if (availableSearchInput && availableContainer) {
        availableSearchInput.addEventListener('keyup', function() {
            const searchTerm = this.value.toLowerCase().trim();
            const availableItems = availableContainer.querySelectorAll('.webinar-item');

            availableItems.forEach(item => {
                const title = item.getAttribute('data-title') || '';
                const tasks = item.getAttribute('data-tasks') || '';
                const textContent = item.textContent.toLowerCase(); // Also search text content

                const isVisible = title.includes(searchTerm) ||
                                  tasks.split(',').some(task => task.trim() === searchTerm) || // Match exact task number
                                  textContent.includes(searchTerm);

                item.style.display = isVisible ? '' : 'none';
            });
            updateCountersAndPlaceholders(); // Update placeholder based on search result
        });
    }


    // Initial counter and placeholder update
    updateCountersAndPlaceholders();

    // --- Added: Handler for "Recalculate Recommendations" button ---
    const recalculateBtn = document.getElementById('recalculate-recommendations');
    if (recalculateBtn) {
        recalculateBtn.addEventListener('click', async () => {
            const quotaT26 = document.getElementById('quota_t26').value || 0;
            const quotaT27 = document.getElementById('quota_t27').value || 0;
            // Используем student.id напрямую в URL, обернув в кавычки
            const studentIdForUrl = "{{ student.id }}"; // Оборачиваем в кавычки
            // IMPORTANT: Define this API endpoint in your Flask routes (e.g., in plans/routes.py)
            const url = `/api/recommendations/${studentIdForUrl}?quota_t26=${quotaT26}&quota_t27=${quotaT27}`;

            recalculateBtn.disabled = true;
            recalculateBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Пересчет...';

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    // Try to get error message from response body if available
                     let errorMsg = `HTTP error! status: ${response.status}`;
                     try {
                         const errorData = await response.json();
                         errorMsg = errorData.error || errorMsg;
                     } catch(e) { /* Ignore if response body is not JSON */ }
                    throw new Error(errorMsg);
                }
                const data = await response.json();

                // Reset current plan state in UI
                const currentWebinarItems = document.querySelectorAll('.webinar-item'); // Get ALL items again
                currentWebinarItems.forEach(item => {
                     const checkbox = item.querySelector('.webinar-checkbox');
                     const weekSelect = item.querySelector('.week-select');
                     if (checkbox) checkbox.checked = false;
                     if (weekSelect) {
                         weekSelect.value = '1'; // Reset to week 1
                         weekSelect.disabled = true;
                     }
                     item.querySelector('.webinar-card')?.classList.remove('selected-webinar');
                     // Move ALL to available using appendChild
                      if(availableContainer) availableContainer.appendChild(item);
                });

                 // Short delay to allow DOM updates before applying new state
                 await new Promise(resolve => setTimeout(resolve, 50));


                // Apply new recommendations
                if (data.recommended_webinars && data.webinar_weeks) {
                    data.recommended_webinars.forEach(webinarData => {
                        const webinarId = webinarData.id;
                        const weekNum = data.webinar_weeks[webinarId] || 1;
                        // Find the item again within the available container (or potentially anywhere)
                        const item = document.querySelector(`.webinar-item[data-webinar-id="${webinarId}"]`);

                        if (item) {
                            const checkbox = item.querySelector('.webinar-checkbox');
                            const weekSelect = item.querySelector('.week-select');
                            if (checkbox) checkbox.checked = true;
                            if (weekSelect) {
                                 weekSelect.value = weekNum;
                                 weekSelect.disabled = false;
                            }
                            item.querySelector('.webinar-card')?.classList.add('selected-webinar');
                            // Move recommended to its week using appendChild
                             if(weekContainers[weekNum]) weekContainers[weekNum].appendChild(item);
                             else if(availableContainer) availableContainer.appendChild(item); // Fallback
                        } else {
                             console.warn(`Recommended webinar ${webinarId} not found after reset.`);
                        }
                    });
                }

                 // Update counters and placeholders AFTER applying recommendations
                 updateCountersAndPlaceholders();


            } catch (error) {
                console.error('Error recalculating recommendations:', error);
                alert(`Не удалось получить новые рекомендации: ${error.message}`);
            } finally {
                recalculateBtn.disabled = false;
                recalculateBtn.innerHTML = '<i class="fas fa-redo me-1"></i> Пересчитать рекомендации';
            }
        });
    }
     // --- End of Recalculate button handler ---
});
</script>
{% endblock %} 