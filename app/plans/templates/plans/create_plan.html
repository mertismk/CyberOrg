{% extends "base.html" %}

{% block title %}{{ student.first_name }} {{ student.last_name }} - Создание плана{% endblock %}

{% block styles %}
<style>
    /* Стили для улучшения интерфейса */
    .webinar-card {
        transition: all 0.2s ease;
        cursor: pointer;
    }
    .webinar-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    .filter-buttons .btn {
        margin-bottom: 5px;
    }
    .webinar-cover {
        height: 180px;
        display: flex;
        justify-content: center;
        align-items: center;
        overflow: hidden;
        position: relative;
        background-color: #f8f9fa;
        border-radius: calc(0.375rem - 1px) calc(0.375rem - 1px) 0 0;
    }
    .webinar-cover img {
        object-fit: contain;
        max-width: 100%;
        max-height: 100%;
        padding: 0;
    }
    .webinar-cover .btn {
        opacity: 0.8;
        transition: opacity 0.2s ease;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .webinar-cover .btn:hover {
        opacity: 1;
    }
    .task-badge-container {
        min-height: 50px; /* Обеспечивает минимальную высоту */
        display: block; /* Или inline-block, если нужно */
    }
    .badge {
        display: inline-block; /* Убедитесь, что бэджи могут переноситься */
        margin-right: 2px;
        margin-bottom: 3px; /* Добавляет отступ снизу */
    }
    .webinar-title {
        min-height: 60px; /* Минимальная высота для заголовка */
        display: -webkit-box;
        -webkit-line-clamp: 3; /* Ограничиваем 3 строками */
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    .card-body {
        padding: 1rem; /* Стандартный отступ */
    }
    .selected-webinar {
        border: 2px solid #0d6efd; /* Выделяем выбранные */
    }
    .week-section .card {
        background-color: #f8f9fa; /* Легкий фон для карточек в плане */
    }
    .available-webinars-container .card {
        background-color: #ffffff; /* Белый фон для доступных */
    }
    .week-container {
        min-height: 200px; /* Чтобы контейнер не схлопывался */
        background-color: rgba(0,0,0,0.02);
        border: 1px dashed #ddd;
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 5px;
    }
    .week-container-header {
        font-weight: bold;
        margin-bottom: 15px;
        color: #555;
    }
    .webinar-placeholder {
        text-align: center;
        color: #aaa;
        padding: 20px;
        font-style: italic;
    }

    /* Стили для мобильных устройств */
    @media (max-width: 768px) {
        .filter-buttons {
            margin-top: 10px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Создание плана для {{ student.first_name }} {{ student.last_name }}</h2>
        <a href="{{ url_for('students.student_detail', student_id=student.id) }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i> Назад к ученику
        </a>
    </div>

    {# Возвращаем информационное сообщение #}
    {% if is_first_plan and (student.initial_score is none or student.initial_score <= 40) %}
        {% set target_requires_26 = 26 in required_tasks %}
        {% set target_requires_27 = 27 in required_tasks %}
        {% if target_requires_26 or target_requires_27 %}
            <div class="alert alert-info alert-dismissible fade show" role="alert">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Обратите внимание:</strong> Задания 
                {% if target_requires_26 and target_requires_27 %}26 и 27{% elif target_requires_26 %}26{% else %}27{% endif %}
                 будут рекомендованы, начиная со следующего плана, т.к. это первый план и начальный балл невысок.
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endif %}
    {% endif %}

    <div class="row">
        <!-- Информация об ученике -->
        <div class="col-md-3 mb-4">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">Информация об ученике</h5>
                </div>
                <div class="card-body">
                    <h5>{{ student.last_name }} {{ student.first_name }}</h5>
                    <p class="text-muted">ID на платформе: {{ student.platform_id }}</p>
                    
                    <dl class="row mb-0">
                        <dt class="col-sm-5">Целевой балл:</dt>
                        <dd class="col-sm-7">{{ student.target_score or 'Не указан' }}</dd>
                        
                        <dt class="col-sm-5">Часов в неделю:</dt>
                        <dd class="col-sm-7">{{ student.hours_per_week or 'Не указано' }}</dd>
                        
                        <dt class="col-sm-5">Уровень:</dt>
                        <dd class="col-sm-7">
                            {% if student.is_beginner %}
                                <span class="badge bg-info">Начинающий</span>
                            {% else %}
                                <span class="badge bg-success">Базовый</span>
                            {% endif %}
                            
                            {% if 26 in known_task_numbers %}
                                <span class="badge bg-warning">Задание 26</span>
                            {% endif %}
                            
                            {% if 27 in known_task_numbers %}
                                <span class="badge bg-danger">Задание 27</span>
                            {% endif %}
                        </dd>
                    </dl>
                </div>
            </div>
            
            <!-- Известные задания -->
            <div class="card shadow mt-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">Обязательные задания</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">Задания, которые нужно изучить для целевого балла {{ student.target_score or 80 }}:</p>
                    <div class="row">
                        {% set target_score = student.target_score or 80 %}
                        
                        {# Определяем диапазон заданий в зависимости от целевого балла #}
                        {% if target_score <= 70 %}
                            {% set required_tasks = range(1, 24) %}  {# 1-23 задания #}
                        {% elif target_score > 70 and target_score <= 85 %}
                            {% set required_tasks = range(1, 26) %}  {# 1-25 задания #}
                        {% elif target_score > 85 and target_score <= 95 %}
                            {% set required_tasks = range(1, 27) %}  {# 1-26 задания #}
                        {% else %}
                            {% set required_tasks = range(1, 28) %}  {# 1-27 задания #}
                        {% endif %}
                        
                        {% for i in required_tasks %}
                            <div class="col-3 mb-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="task_{{ i }}" 
                                        {% if i in known_task_numbers %}checked{% endif %} disabled>
                                    <label class="form-check-label" for="task_{{ i }}">
                                        {% if i in known_task_numbers %}
                                            <span class="text-success">№{{ i }}</span>
                                        {% else %}
                                            <span>№{{ i }}</span>
                                        {% endif %}
                                    </label>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            
            <!-- Дополнительные задания -->
            <div class="card shadow mt-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">Дополнительные задания</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">Задания, которые не входят в минимум для целевого балла, но могут быть полезны:</p>
                    
                    <div class="row">
                        {% set all_tasks = range(1, 28) %}
                        {% set other_tasks_found = false %}
                        
                        {% for i in all_tasks %}
                            {% if i not in required_tasks %}
                                {% set other_tasks_found = true %}
                                <div class="col-3 mb-2">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="other_task_{{ i }}" 
                                            {% if i in known_task_numbers %}checked{% endif %} disabled>
                                        <label class="form-check-label" for="other_task_{{ i }}">
                                            {% if i in known_task_numbers %}
                                                <span class="text-success">№{{ i }}</span>
                                            {% else %}
                                                <span>№{{ i }}</span>
                                            {% endif %}
                                        </label>
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}
                        
                        {% if not other_tasks_found %}
                            <p>Все задания включены в основной план подготовки.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-9">
            <form method="post" id="create-plan-form" action="{{ url_for('plans.create_study_plan', student_id=student.id) }}">
                {# Используем переданную переменную #}
                <input type="hidden" name="csrf_token" value="{{ csrf_token_value }}"/> 
                
                <div class="d-grid gap-2 d-md-flex justify-content-md-end mb-4">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i> Сохранить план обучения
                    </button>
                </div>
                
                {# Добавляем блок настройки квот СЮДА #}
                <!-- 
                <div class="card shadow mb-4">
                    <div class="card-header bg-light border-bottom d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0"><i class="fas fa-sliders-h me-2"></i>Настройка квот Т26/Т27</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted small">Укажите желаемое количество вебинаров. Итоговый план будет сформирован после сохранения с учетом этих квот и бюджета часов.</p>
                        <div class="row g-3 align-items-center">
                            <div class="col-auto">
                                <label for="quota_t26" class="col-form-label">Желаемое кол-во вебинаров по <strong>№26</strong>:</label>
                            </div>
                            <div class="col-auto">
                                <input type="number" id="quota_t26" name="quota_t26" class="form-control form-control-sm" value="{{ request.args.get('quota_t26', 0) }}" min="0" style="width: 80px;">
                            </div>
                            <div class="col-auto">
                                <label for="quota_t27" class="col-form-label">Желаемое кол-во вебинаров по <strong>№27</strong>:</label>
                            </div>
                            <div class="col-auto">
                                <input type="number" id="quota_t27" name="quota_t27" class="form-control form-control-sm" value="{{ request.args.get('quota_t27', 0) }}" min="0" style="width: 80px;">
                            </div>
                        </div>
                    </div>
                </div>
                -->
                
                <div class="card shadow mb-4">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">Рекомендуемые вебинары</h5>
                        <button type="button" class="btn btn-sm btn-light" data-bs-toggle="collapse" data-bs-target="#recommendedWebinarsCollapse" aria-expanded="true">
                            <i class="fas fa-chevron-down"></i>
                        </button>
                    </div>
                    <div class="card-body collapse show" id="recommendedWebinarsCollapse">
                        {% if weekly_hours_summary %}
                        <div class="card bg-light mb-4 border">
                            <div class="card-body p-3">
                                <h6 class="card-title mb-2"><i class="far fa-clock me-2"></i>Примерная нагрузка по неделям:</h6>
                                <div class="d-flex justify-content-around text-center">
                                    {% for week, hours in weekly_hours_summary.items()|sort %}
                                    <div class="px-2">
                                        <div class="fw-bold">Неделя {{ week }}</div>
                                        <div class="badge {% if hours > student.hours_per_week|default(9) %}bg-danger{% elif hours > student.hours_per_week|default(9) * 0.8 %}bg-warning text-dark{% else %}bg-success{% endif %}">
                                            ~{{ hours|round(1) }} ч.
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                <small class="text-muted d-block mt-2">*Нагрузка может незначительно отличаться, если вы вручную измените состав вебинаров.</small>
                            </div>
                        </div>
                        {% endif %}

                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i> Система подобрала {{ suitable_webinars|length }} вебинаров на ближайшие 4 недели на основе целевого балла и текущего уровня ученика (с учетом квот по умолчанию).
                        </div>
                        <div class="recommended-webinars">
                            {% for week_num in range(1, 5) %}
                            <div class="week-container mb-4 border rounded p-3" data-week="{{ week_num }}">
                                <h5 class="week-title border-bottom pb-2 mb-3">Неделя {{ week_num }}</h5>
                                <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3 week-content">
                                    {# Создаем список вебинаров ТОЛЬКО для этой недели #}
                                    {% set webinars_for_this_week = [] %}
                                    {% for webinar in suitable_webinars %}
                                        {% if webinar_weeks.get(webinar.id) == week_num %}
                                            {% set _ = webinars_for_this_week.append(webinar) %}
                                        {% endif %}
                                    {% endfor %}

                                    {# Проверяем, пуст ли список для этой недели #}
                                    {% if webinars_for_this_week %}
                                        {# Если не пуст, отображаем вебинары из этого списка #}
                                        {% for webinar in webinars_for_this_week %}
                                            <div class="col webinar-item">
                                                <div class="card webinar-card h-100 shadow-sm {% if webinar.id in watched_webinar_ids %}border-secondary bg-light opacity-75{% elif webinar.id in (request.form.getlist('webinar_ids') if request.method == 'POST' else []) %}border-primary{% endif %}" 
                                                     data-webinar-id="{{ webinar.id }}"
                                                     data-week="{{ webinar_weeks.get(webinar.id, 1) }}"> 
                                                    <div class="webinar-cover">
                                                        {% if webinar.cover_url %}
                                                            <img src="{{ webinar.cover_url }}" class="card-img-top" alt="{{ webinar.title }}" style="object-fit: cover; height: 100%; width: 100%; border-radius: calc(0.375rem - 1px) calc(0.375rem - 1px) 0 0;">
                                                        {% else %}
                                                            <div class="d-flex align-items-center justify-content-center h-100 w-100" style="background-color: #e9ecef;">
                                                                <i class="fas fa-photo-video fa-3x text-muted"></i>
                                                            </div>
                                                        {% endif %}
                                                    </div>
                                                    <div class="card-body d-flex flex-column">
                                                        <div class="d-flex align-items-start mb-2">
                                                            <div class="form-check pt-1 me-2 flex-shrink-0">
                                                                <input type="checkbox" class="form-check-input webinar-checkbox" name="webinar_ids" value="{{ webinar.id }}" id="webinar-check-{{ webinar.id }}" checked>
                                                                <input type="hidden" name="week_numbers_{{ webinar.id }}" value="{{ webinar_weeks.get(webinar.id, 1) }}">
                                                            </div>
                                                            <div class="flex-grow-1">
                                                                <label for="webinar-check-{{ webinar.id }}" class="fw-bold webinar-title mb-1" style="cursor: pointer;">
                                                                    {{ webinar.title }}
                                                                </label>
                                                                <p class="card-text small text-muted mb-2 d-flex align-items-center">
                                                                    <i class="far fa-calendar-alt me-1"></i> {{ webinar.date|moscow_time if webinar.date else 'Не указана' }}
                                                                    <a href="{{ webinar.url }}" target="_blank" class="ms-auto link-secondary" title="Открыть в Школково" onclick="event.stopPropagation();">
                                                                        <i class="fas fa-external-link-alt fa-sm"></i>
                                                                    </a>
                                                                </p>
                                                            </div>
                                                        </div>

                                                        {# --- Начало блока тегов --- #}
                                                        <div class="mt-auto pt-2">
                                                            {# Теги для задач #}
                                                            <div class="mb-2">
                                                                {% for task in webinar.task_numbers|sort(attribute='number') %}
                                                                    <span class="badge bg-secondary me-1 mb-1">№{{ task.number }}</span>
                                                                {% else %}
                                                                    <span class="badge bg-light text-dark border me-1 mb-1">Без задач</span>
                                                                {% endfor %}
                                                            </div>

                                                            {# Теги категории, типа решения и ТИПА КУРСА (измененная логика) #}
                                                            <div class="mb-2">
                                                                {# Категория (Обяз/Повтор/Необяз/Продв) #}
                                                                {% if webinar.category == 1 %}<span class="badge bg-success me-1 mb-1"><i class="fas fa-star me-1"></i>Обязательный</span>{% endif %}
                                                                {% if webinar.category == 2 %}<span class="badge bg-warning text-dark me-1 mb-1"><i class="fas fa-redo me-1"></i>Повторение</span>{% endif %}
                                                                {% if webinar.category == 3 %}<span class="badge bg-info text-dark me-1 mb-1"><i class="fas fa-leaf me-1"></i>Не обязательный</span>{% endif %}
                                                                {% if webinar.category == 4 %}<span class="badge bg-danger me-1 mb-1"><i class="fas fa-fire me-1"></i>Для продвинутых</span>{% endif %}

                                                                {# Тип решения #}
                                                                {% if webinar.is_programming %}<span class="badge bg-primary me-1 mb-1"><i class="fas fa-code me-1"></i>Код</span>{% endif %}
                                                                {% if webinar.is_manual %}<span class="badge bg-secondary me-1 mb-1"><i class="fas fa-pencil-alt me-1"></i>Руки</span>{% endif %}
                                                                {% if webinar.is_excel %}<span class="badge bg-success me-1 mb-1"><i class="fas fa-file-excel me-1"></i>Excel</span>{% endif %}
                                                                
                                                                {# --- ИЗМЕНЕННАЯ ЛОГИКА ТЕГА ТИПА КУРСА --- #}
                                                                {% set webinar_task_nums = webinar.task_numbers|map(attribute='number')|list %}
                                                                {% if webinar.for_beginners %}
                                                                    <span class="badge bg-info text-dark me-1 mb-1"><i class="fas fa-baby me-1"></i>Python с нуля</span>
                                                                {% elif 27 in webinar_task_nums %}
                                                                    <span class="badge bg-purple me-1 mb-1"><i class="fas fa-crown me-1"></i>Задание 27</span>
                                                                {% elif 26 in webinar_task_nums %}
                                                                    <span class="badge bg-orange text-dark me-1 mb-1"><i class="fas fa-brain me-1"></i>Задание 26</span>
                                                                {% elif not webinar.for_mocks and not webinar.for_practice and not webinar.for_minisnap %}
                                                                    {# Показываем 'Основной курс' только если это не пробник/практика/минищелчок и не 26/27/beginners #}
                                                                    <span class="badge bg-success me-1 mb-1"><i class="fas fa-graduation-cap me-1"></i>Основной курс</span>
                                                                {% endif %}
                                                                {# --- КОНЕЦ ИЗМЕНЕНИЙ --- #}
                                                                
                                                                {# Доп. типы (пробник, нарешка, щелчок) #}
                                                                {% if webinar.for_mocks %}<span class="badge bg-secondary me-1 mb-1"><i class="fas fa-file-alt me-1"></i>Разбор пробника</span>{% endif %}
                                                                {% if webinar.for_practice %}<span class="badge bg-primary me-1 mb-1"><i class="fas fa-dumbbell me-1"></i>Нарешка</span>{% endif %}
                                                                {% if webinar.for_minisnap %}<span class="badge bg-dark me-1 mb-1"><i class="fas fa-bolt me-1"></i>Мини-щелчок</span>{% endif %}
                                                            </div>
                                                        </div>
                                                        {# --- Конец блока тегов --- #}

                                                        <div class="d-flex justify-content-between align-items-center border-top pt-2">
                                                            <span class="small text-muted">Длит: ~{{ get_webinar_hours(webinar) }} ч.</span>
                                                            <button type="button" class="btn btn-sm btn-outline-danger remove-webinar-btn" title="Убрать из рекомендованных">
                                                                <i class="fas fa-times"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    {% else %}
                                        {# Если список пуст, показываем сообщение #}
                                        <div class="col-12">
                                            <p class="text-muted fst-italic">На этой неделе рекомендуемых вебинаров нет.</p>
                                        </div>
                                    {% endif %}
                                </div> {# End row for week content #}
                            </div> {# End week-container #}
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <div class="card shadow mb-4">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">Все вебинары</h5>
                        <button type="submit" class="btn btn-sm btn-light">
                            <i class="fas fa-save me-1"></i> Сохранить план
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i> В этом разделе вы можете выбрать дополнительные вебинары, которые не были автоматически рекомендованы системой или уже просмотрены учеником.
                        </div>
                        
                        <div class="mb-3 webinar-filters">
                            <input type="text" id="webinarSearchInput" class="form-control mb-2" placeholder="Поиск вебинаров...">
                            <div class="btn-group filter-buttons">
                                <button type="button" class="btn btn-outline-primary filter-btn active" data-filter="all">Все</button>
                                <button type="button" class="btn btn-outline-primary filter-btn" data-filter="for_beginners">Python с нуля</button>
                                <button type="button" class="btn btn-outline-primary filter-btn" data-filter="for_basic">Основной курс</button>
                                <button type="button" class="btn btn-outline-primary filter-btn" data-filter="for_advanced">Хард прога</button>
                                <button type="button" class="btn btn-outline-primary filter-btn" data-filter="for_expert">Задание 27</button>
                                <button type="button" class="btn btn-outline-primary filter-btn" data-filter="for_mocks">Разбор пробников</button>
                                <button type="button" class="btn btn-outline-primary filter-btn" data-filter="for_practice">Нарешка</button>
                                <button type="button" class="btn btn-outline-primary filter-btn" data-filter="for_minisnap">Мини-щелчок</button>
                            </div>
                        </div>

                        <!-- РАСШИРЕННЫЕ ФИЛЬТРЫ (Начало) -->
                        <div class="card mb-4 bg-light border">
                            <div class="card-header py-2">
                                <a href="#additionalAdvancedFilters" data-bs-toggle="collapse" class="text-decoration-none text-dark fw-bold">
                                    <i class="fas fa-filter me-2"></i> Дополнительные фильтры
                                    <i class="fas fa-chevron-down float-end mt-1"></i>
                                </a>
                            </div>
                            <div id="additionalAdvancedFilters" class="collapse">
                                <div class="card-body pb-2">
                                    <div class="row g-3">
                                        <!-- Фильтр по дате -->
                                        <div class="col-md-6">
                                            <label class="form-label small mb-1"><i class="fas fa-calendar-alt me-1"></i> По дате</label>
                                            <div class="btn-group w-100" role="group">
                                                <button type="button" class="btn btn-sm btn-outline-secondary date-filter active" data-filter="all">Все</button>
                                                <button type="button" class="btn btn-sm btn-outline-secondary date-filter" data-filter="new">Новые сначала</button>
                                                <button type="button" class="btn btn-sm btn-outline-secondary date-filter" data-filter="old">Старые сначала</button>
                                            </div>
                                        </div>
                                        
                                        <!-- Фильтр по типу решения -->
                                        <div class="col-md-6">
                                            <label class="form-label small mb-1"><i class="fas fa-code me-1"></i> Тип решения</label>
                                            <div class="btn-group w-100" role="group">
                                                <button type="button" class="btn btn-sm btn-outline-secondary solution-filter active" data-filter="all">Все</button>
                                                <button type="button" class="btn btn-sm btn-outline-secondary solution-filter" data-filter="is_programming">Программирование</button>
                                                <button type="button" class="btn btn-sm btn-outline-secondary solution-filter" data-filter="is_manual">Ручное решение</button>
                                            </div>
                                        </div>
                                        
                                        <!-- Фильтр по категории -->
                                        <div class="col-md-6">
                                            <label class="form-label small mb-1"><i class="fas fa-tags me-1"></i> Категория</label>
                                            <div class="d-flex flex-wrap gap-1">
                                                <button type="button" class="btn btn-sm btn-outline-secondary category-filter active" data-filter="all">Все</button>
                                                <button type="button" class="btn btn-sm btn-outline-success category-filter" data-filter="category-1">Обязательный</button>
                                                <button type="button" class="btn btn-sm btn-outline-info category-filter" data-filter="category-2">Повторение</button>
                                                <button type="button" class="btn btn-sm btn-outline-secondary category-filter" data-filter="category-3">Необязательный</button>
                                            </div>
                                        </div>
                                        
                                        <!-- Фильтр по номерам заданий -->
                                        <div class="col-md-6">
                                            <label for="taskFilterSelect" class="form-label small mb-1"><i class="fas fa-hashtag me-1"></i> Номер задания</label>
                                            <select class="form-select form-select-sm" id="taskFilterSelect">
                                                <option value="all" selected>Все задания</option>
                                                {% for i in range(1, 28) %}
                                                    <option value="task-{{ i }}">№{{ i }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        
                                        <!-- Сброс фильтров -->
                                        <div class="col-12 mt-3">
                                            <button type="button" class="btn btn-sm btn-danger" id="resetAllFilters">
                                                <i class="fas fa-undo me-2"></i> Сбросить все фильтры
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- РАСШИРЕННЫЕ ФИЛЬТРЫ (Конец) -->
                        
                        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3 all-webinars">
                            {% for webinar in other_webinars %}
                                <div class="col webinar-item 
                                        {% if webinar.for_beginners %}for_beginners{% endif %}
                                        {% if webinar.for_basic %}for_basic{% endif %}
                                        {% if webinar.for_advanced %}for_advanced{% endif %}
                                        {% if webinar.for_expert %}for_expert{% endif %}
                                        {% if webinar.for_mocks %}for_mocks{% endif %}
                                        {% if webinar.for_practice %}for_practice{% endif %}
                                        {% if webinar.for_minisnap %}for_minisnap{% endif %}
                                        {% if webinar.is_programming %} is_programming{% endif %}
                                        {% if webinar.is_manual %} is_manual{% endif %}
                                        {% if webinar.category %} category-{{ webinar.category }}{% endif %}
                                        {% for task in webinar.task_numbers %} task-{{ task.number }}{% endfor %}
                                        {% if webinar.date %} date-{{ webinar.date.strftime('%Y-%m-%d') }}{% endif %}
                                    " data-id="{{ webinar.id }}">
                                        <div class="card webinar-card h-100" data-id="{{ webinar.id }}">
                                            <div class="webinar-cover">
                                                {% if webinar.cover_url %}
                                                    <img src="{{ webinar.cover_url }}" class="card-img-top" alt="{{ webinar.title }}">
                                                {% else %}
                                                    <div class="text-center text-muted">
                                                        <i class="fas fa-video fa-3x"></i>
                                                    </div>
                                                {% endif %}
                                                <div class="position-absolute top-0 end-0 m-2">
                                                    <a href="{{ webinar.url }}" target="_blank" class="btn btn-sm btn-light rounded-circle" title="Открыть вебинар">
                                                        <i class="fas fa-external-link-alt"></i>
                                                    </a>
                                                    <button type="button" class="btn btn-sm btn-light rounded-circle copy-link-btn" data-url="{{ webinar.url }}" title="Скопировать ссылку">
                                                        <i class="fas fa-copy"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="card-body">
                                                <h6 class="card-title webinar-title">{{ webinar.title }}</h6>
                                                <div class="task-badge-container mb-2">
                                                    {% for task in webinar.task_numbers %}
                                                        <span class="badge bg-secondary me-1 mb-1">№{{ task.number }}</span>
                                                    {% endfor %}
                                                    
                                                    {% if webinar.category == 1 %}
                                                        <span class="badge bg-success me-1 mb-1">Обязательный</span>
                                                    {% elif webinar.category == 2 %}
                                                        <span class="badge bg-info me-1 mb-1">Повторение</span>
                                                    {% elif webinar.category == 3 %}
                                                        <span class="badge bg-secondary me-1 mb-1">Необязательный</span>
                                                    {% endif %}
                                                    
                                                    {% if webinar.is_programming and webinar.is_manual %}
                                                        <span class="badge bg-primary me-1 mb-1">Программирование</span>
                                                        <span class="badge bg-warning text-dark me-1 mb-1">Ручное решение</span>
                                                    {% elif webinar.is_programming %}
                                                        <span class="badge bg-primary me-1 mb-1">Программирование</span>
                                                    {% elif webinar.is_manual %}
                                                        <span class="badge bg-warning text-dark me-1 mb-1">Ручное решение</span>
                                                    {% endif %}
                                                </div>
                                                <div class="mt-2 small text-muted">
                                                    <div>Дата: {{ webinar.date|moscow_time }}</div>
                                                    <div>ID: {{ webinar.url[-5:] if webinar.url|length >= 5 else webinar.url }}</div>
                                                </div>
                                            </div>
                                            <div class="card-footer bg-transparent d-flex justify-content-between align-items-center">
                                                <select class="form-select form-select-sm week-select" name="week_numbers_{{ webinar.id }}" style="width: 120px;">
                                                    {% for week in range(1, 5) %}
                                                        <option value="{{ week }}">Неделя {{ week }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                
                <div class="d-grid gap-2 d-md-flex justify-content-md-end mb-4">
                    <a href="{{ url_for('students.student_detail', student_id=student.id) }}" class="btn btn-secondary me-md-2">Отмена</a>
                    <button type="submit" class="btn btn-primary">Сохранить план обучения</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Обработчик ошибок загрузки изображений
        document.querySelectorAll('.webinar-cover img').forEach(function(img) {
            img.onerror = function() {
                this.src = "{{ url_for('static', filename='images/sorry.png') }}";
                this.classList.add('fallback-img');
            };
        });

        // Текущее состояние фильтров
        const activeFilters = {
            courseCategory: 'all',
            date: 'all',
            solution: 'all',
            category: 'all',
            tasks: []
        };
        
        // Элементы DOM
        const filterInput = document.getElementById('webinarSearchInput');
        const cardsContainer = document.querySelector('.all-webinars');
        const filterButtons = document.querySelectorAll('.filter-btn');
        const dateFilterButtons = document.querySelectorAll('.date-filter');
        const solutionFilterButtons = document.querySelectorAll('.solution-filter');
        const categoryFilterButtons = document.querySelectorAll('.category-filter');
        const taskFilterSelect = document.getElementById('taskFilterSelect');
        const resetButton = document.getElementById('resetAllFilters');

        // Фильтрация по тексту
        if (filterInput) {
            filterInput.addEventListener('keyup', function() {
                applyFilters();
            });
        }
        
        // Фильтрация по основным кнопкам курса
        filterButtons.forEach(function(button) {
            button.addEventListener('click', function() {
                const filter = this.getAttribute('data-filter');
                filterButtons.forEach(btn => btn.classList.remove('active', 'btn-primary'));
                filterButtons.forEach(btn => btn.classList.add('btn-outline-primary'));
                this.classList.remove('btn-outline-primary');
                this.classList.add('active', 'btn-primary');
                activeFilters.courseCategory = filter;
                applyFilters();
            });
        });
        
        // Фильтрация по дате
        dateFilterButtons.forEach(function(button) {
            button.addEventListener('click', function() {
                const filter = this.getAttribute('data-filter');
                dateFilterButtons.forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                activeFilters.date = filter;
                applyFilters();
            });
        });
        
        // Фильтрация по типу решения
        solutionFilterButtons.forEach(function(button) {
            button.addEventListener('click', function() {
                const filter = this.getAttribute('data-filter');
                solutionFilterButtons.forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                activeFilters.solution = filter;
                applyFilters();
            });
        });
        
        // Фильтрация по категории
        categoryFilterButtons.forEach(function(button) {
            button.addEventListener('click', function() {
                const filter = this.getAttribute('data-filter');
                categoryFilterButtons.forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                activeFilters.category = filter;
                applyFilters();
            });
        });
        
        // Фильтрация по номерам заданий
        if (taskFilterSelect) {
            taskFilterSelect.addEventListener('change', function() {
                const filter = this.value;
                if (filter === 'all') {
                    activeFilters.tasks = [];
                } else {
                    activeFilters.tasks = [filter];
                }
                applyFilters();
            });
        }
        
        // Кнопка сброса всех фильтров
        if (resetButton) {
            resetButton.addEventListener('click', function() {
                activeFilters.courseCategory = 'all';
                activeFilters.date = 'all';
                activeFilters.solution = 'all';
                activeFilters.category = 'all';
                activeFilters.tasks = [];

                if (filterInput) {
                    filterInput.value = '';
                }

                filterButtons.forEach(btn => {
                    btn.classList.remove('active', 'btn-primary');
                    btn.classList.add('btn-outline-primary');
                    if (btn.getAttribute('data-filter') === 'all') {
                        btn.classList.add('active', 'btn-primary');
                        btn.classList.remove('btn-outline-primary');
                    }
                });

                dateFilterButtons.forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.getAttribute('data-filter') === 'all') {
                        btn.classList.add('active');
                    }
                });

                solutionFilterButtons.forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.getAttribute('data-filter') === 'all') {
                        btn.classList.add('active');
                    }
                });

                categoryFilterButtons.forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.getAttribute('data-filter') === 'all') {
                        btn.classList.add('active');
                    }
                });

                if (taskFilterSelect) {
                    taskFilterSelect.value = 'all';
                }

                applyFilters();
            });
        }
        
        // Функция применения всех фильтров
        function applyFilters() {
            if (!cardsContainer) return;

            // Важно: хранить оригинальные карточки для правильной работы последовательной фильтрации
            if (!window.originalWebinarCards) {
                window.originalWebinarCards = Array.from(document.querySelectorAll('.all-webinars .webinar-item'));
            }
            
            // Клонируем оригинальные карточки для фильтрации
            const allCards = window.originalWebinarCards.map(card => card.cloneNode(true));
            const searchText = filterInput ? filterInput.value.toLowerCase() : '';

            // ФИЛЬТРАЦИЯ
            const filteredCards = [];
            
            allCards.forEach(card => {
                let shouldShow = true;
                const cardText = card.textContent.toLowerCase();
                const cardClasses = Array.from(card.classList);
                
                // 1. Текстовый поиск
                if (searchText && !cardText.includes(searchText)) {
                    shouldShow = false;
                }

                // 2. Категория курса
                if (shouldShow && activeFilters.courseCategory !== 'all') {
                    if (!cardClasses.some(cls => cls.includes(activeFilters.courseCategory))) {
                        shouldShow = false;
                    }
                }

                // 3. Тип решения
                if (shouldShow && activeFilters.solution !== 'all') {
                    if (!cardClasses.some(cls => cls.includes(activeFilters.solution))) {
                        shouldShow = false;
                    }
                }

                // 4. Категория обязательности
                if (shouldShow && activeFilters.category !== 'all') {
                    if (!cardClasses.some(cls => cls.includes(activeFilters.category))) {
                        shouldShow = false;
                    }
                }

                // 5. Задания
                if (shouldShow && activeFilters.tasks.length > 0) {
                    const cardTaskClasses = cardClasses
                        .filter(cls => cls.includes('task-'))
                        .map(cls => cls.trim());
                    
                    let hasAnyTask = false;
                    for (const task of activeFilters.tasks) {
                        if (cardTaskClasses.some(cls => cls === task)) {
                            hasAnyTask = true;
                            break;
                        }
                    }
                    if (!hasAnyTask) {
                        shouldShow = false;
                    }
                }

                if (shouldShow) {
                    filteredCards.push(card);
                }
            });

            // Сортировка по дате, если активен соответствующий фильтр
            if (activeFilters.date === 'new' || activeFilters.date === 'old') {
                filteredCards.sort((a, b) => {
                    // Извлекаем даты из текстового содержимого карточек
                    const aDateText = a.querySelector('.small.text-muted')?.textContent || '';
                    const bDateText = b.querySelector('.small.text-muted')?.textContent || '';
                    
                    // Используем регулярное выражение для извлечения даты
                    const aDateMatch = aDateText.match(/Дата: (.*?)(?:\n|$)/);
                    const bDateMatch = bDateText.match(/Дата: (.*?)(?:\n|$)/);
                    
                    // Если не удалось найти дату, вернуть карточку в конец списка
                    if (!aDateMatch) return 1;
                    if (!bDateMatch) return -1;
                    
                    // Преобразуем строки дат в объекты Date
                    const aDate = new Date(aDateMatch[1]);
                    const bDate = new Date(bDateMatch[1]);
                    
                    // Сортировка по убыванию (новые сначала) или возрастанию (старые сначала)
                    return activeFilters.date === 'new' ? bDate - aDate : aDate - bDate;
                });
            }

            // Очищаем контейнер
            while (cardsContainer.firstChild) {
                cardsContainer.removeChild(cardsContainer.firstChild);
            }
            
            // Добавляем отфильтрованные карточки в контейнер
            if (filteredCards.length > 0) {
                filteredCards.forEach(card => {
                    // Восстанавливаем все обработчики событий для клонированных карточек
                    const originalCard = window.originalWebinarCards.find(
                        original => original.getAttribute('data-id') === card.getAttribute('data-id')
                    );
                    if (originalCard) {
                        cardsContainer.appendChild(originalCard);
                        originalCard.style.display = '';
                    }
                });
            } else {
                // Показываем сообщение, если нет результатов
                const noResultsMessage = document.createElement('div');
                noResultsMessage.className = 'col-12 text-center my-5 no-results-message';
                noResultsMessage.innerHTML = `
                    <div class="alert alert-info">
                        <img src="{{ url_for('static', filename='images/sorry.png') }}" alt="Нет результатов" class="img-fluid mb-3" style="max-height: 150px;">
                        <h5 class="mt-2"><i class="fas fa-info-circle me-2"></i> Нет вебинаров</h5>
                        <p>Попробуйте изменить фильтры или поисковый запрос.</p>
                        <button class="btn btn-sm btn-outline-primary ms-3" id="resetFiltersBtn">Сбросить фильтры</button>
                    </div>
                `;
                cardsContainer.appendChild(noResultsMessage);
                document.getElementById('resetFiltersBtn').addEventListener('click', function() {
                    if (resetButton) resetButton.click();
                });
            }
        }

        // Обработка чекбоксов и селектов
        const webinarCheckboxes = document.querySelectorAll('.webinar-checkbox');
        webinarCheckboxes.forEach(function(checkbox) {
            checkbox.addEventListener('change', function() {
                const card = this.closest('.webinar-card');
                const weekSelect = card.querySelector('.week-select');
                
                if (this.checked) {
                    card.classList.add('selected-webinar');
                    weekSelect.disabled = false;
                } else {
                    card.classList.remove('selected-webinar');
                    weekSelect.disabled = true;
                }
            });
        });
        
        // Клик по карточке вебинара для выбора
        const webinarCards = document.querySelectorAll('.webinar-card');
        webinarCards.forEach(function(card) {
            card.addEventListener('click', function(e) {
                // Не реагируем на клики по селекту и чекбоксу
                if (e.target.tagName === 'SELECT' || e.target.tagName === 'INPUT' || 
                    e.target.tagName === 'OPTION' || e.target.closest('select') || 
                    e.target.closest('.form-check')) {
                    return;
                }
                
                const checkbox = this.querySelector('.webinar-checkbox');
                checkbox.checked = !checkbox.checked;
                
                // Вызываем событие change вручную
                const event = new Event('change', { bubbles: true });
                checkbox.dispatchEvent(event);
            });
        });

        // Добавляем обработчик для копирования ссылок
        document.querySelectorAll('.copy-link-btn').forEach(function(btn) {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                const url = this.getAttribute('data-url');
                navigator.clipboard.writeText(url)
                    .then(() => {
                        // Визуальное подтверждение копирования
                        const originalIcon = this.innerHTML;
                        this.innerHTML = '<i class="fas fa-check"></i>';
                        setTimeout(() => {
                            this.innerHTML = originalIcon;
                        }, 1500);
                    })
                    .catch(err => {
                        console.error('Не удалось скопировать текст: ', err);
                    });
            });
        });
    });
</script>
{% endblock %} 